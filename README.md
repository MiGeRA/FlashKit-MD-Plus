# FlashKit-MD-Plus

Продвинутая и расширенная редакция утилиты работы с интерфейсом (программатором) перезаписываемых Sega MegaDrive/Genesis картриджей – FlashKit MD.

![Flashkit](https://user-images.githubusercontent.com/24475390/150353756-2d6218d3-77a4-4cf7-aeb7-2a62326ed43a.jpg)

### 1.0.0.0
* Стоковая версия [исходников](https://krikzz.com/pub/support/flashkit-md/) от Krikzz

### 1.0.1.0 (непубличная)
+ Добавлена поддержка работы с микросхемой памяти картриджа Intel PA28F400 (4Mbit);
+ Добавлена функция полного стирания микросхем памяти картриджа и последующей проверкой на чистоту;
* Небольшие косметические редакции в коде и информационных сообщениях.

Intel PA28F400 реализует лишь пословную (16-ти разрядный «байт») запись. Управляющая команда на запись предусматривают один шинный цикл, плюс цикл передачи данных. Состояние регистра статуса автоматически выставляется на линии данных после записи/стирания (не требуется шинный цикл к флэшке с управляющей командой на чтение статуса). На практике для экономии общего времени, можно не инициировать проверку статуса после записи, т.к. накладно это – лишняя usb-транзакция передачи команды и получения ответа от программатора (для каждого слова!). Достаточно того что между вызовом функций отправки usb-транзакцией пакета (массива) данных на запись очередного слова происходит вынужденная (неконтролируемая) пауза (хотя всё и тупо в цикле одно за другим). Результат: ~100kB/min (т.е. 5мин на всю микросхему в 512kB).

### 1.0.2.0 (первая публичная - посвящается проекту [Flash-Cart 4MB](https://github.com/MiGeRA/MD-Flash-Cart-4MB))
+ Добавлена поддержка работы с микросхемой постоянной памяти картриджа MXIC MX29L3211 (32Mbit);
+ Оптимизирован алгоритм работы с Intel PA28F400 (кратное увеличение скорости);
* Дальнейшие оптимизации информационных сообщений о процессе работы с памятью, затраченном времени, контрольных суммах и прочем сопутствующем;
* Корректировка определения размера дампа при чтении: приоритет информации из штатного заголовка (а уж если там размер вне диапазона – то используем базовый метод чтоб прочесть максимум хоть что-то).
* Много что еще по мелочам.

Почему так быстро (меньше минуты все 4MB) пишется стоковая серия 29W? В ней есть команда «байпаса», позволяющая при записи каждого слова не подавать команду записи в три шинных цикла флэшки, а использовать сокращенную команду в 1 цикл, да еще при этом упрощен режим фиксации завершения записи слова: на линии данных выставляется не байт статуса, а само записанное слово. Программатор внутри FPGA реализует логику анализа записанного и прочитанного после результата и продолжает дальше «шпарить» из длинного непрерывного потока: одноцикловую команду с последующим словом данных, используя также функцию автоинкремента адреса. «Пулять» в принципе, с точки зрения микросхемы памяти, можно поток любой длины – хоть за раз весь объем. Алгоритм работы с программатором предусматривает деление на куски максимального размера в 64kB – это дает возможность, в том числе, для визуализации шкалы прогресса. Изящное решение получилось у krikzz'а именно в совокупности архитектуры программатора и картриджа с конкретной моделью микросхемой памяти к нему.

Серия 29L (в отличие от 29W, примененной в стоковом решении) не имеет команды «байпаса», но зато предусматривает страничную запись вплоть до 128 слов (256 байт). Запись каждой страницы должна сопровождаться командой из трех шинных циклов флэшки. Потом нужно быстро, не мешкая передавать данные по нужным последовательным адресам в пределах кратности размеров страницы от младших линий адреса (порядок не имеет значения согласно документации, т.е. можно и от старших адресов заполнять буфер, например). Если замешкался – на запись уходит то, что успел загрузить - остальное остается чистым (FF). Завершение записи страницы предусмотрено чекать чтением статуса, автоматически выставляемого на линии данных после ухода данных на запись страницы. При последующей проверке чтением - нужно выявлять «недописанные» страницы и (без предварительного стирания!) просто дописывать («дожигать») их (повторная запись и проверка). Почему именно MX29L3211? – это одна из немногих доступных сейчас в продаже микросхем памяти в корпусе (P)SOP-44 и объемом в 32Mbit, со страничной записью и ценой меньше доллара за штуку.

Intel PA28F400 удалось оптимизировать, причем очень существенно! Казалось бы «программистский изыск»: поместить все данные в единый массив, а не вызывать подряд в цикле несколько раз функцию отправки данных, но выигрыш во времени колоссальный! – аж микросхема не успевает … Еще бы, ведь от чтения статуса мы оказались (в прошлой версии). Возвращать его? – лишние usb-транзакции с программатором, что в итоге минимум в два раза дольше результата достигнутого в 1.0.1.0 Конфигурация FPGA программатора не предусматривает чтение и парсинг состояния байта статуса внутри себя без usb-транзакций, но зато предусматривает возможность генерации задержки работы своего «автомата» измеряемую во внутренних циклах («попугаях», экспериментально это где-то полмикросекунды на единицу). Генерировать задержку отдельным пакетом (от софта к программатору) – терять время сопоставимое команде чтение статуса. Но задержку можно «завернуть» в общий непрерывный массив команд-данных! Да, максимальная задержка в «системе команд» программатора - 7 единиц, но можно их подряд формировать несколько – экспериментально подобрано: 4 раза по 5 (что по замерам около 10 микросекунд). На время задержки программатор вхолостую тратит свои внутренние циклы бездействуя. Результат – вся микросхема пишется корректно за 10сек.

В версии 1.0.2.0 не реализована поддержка работы с памятью MX29LV320 (под которую изначально создавался проект [Flash-Cart 4MB](https://github.com/MiGeRA/MD-Flash-Cart-4MB)), китайцы ошиблись корпусом ;-\

Зазипованный экзешник в [разделе релизов](https://github.com/MiGeRA/FlashKit-MD-Plus/releases).

*PS.* Авторская редакция программатора от krikzz [продается](https://krikzz.com/our-products/accessories/flashkitmd.html) по завышенной цене, KY-tech [продают](https://www.aliexpress.com/item/1005001464361547.html) его рестайлинговую версию (имхо более изящно спроектированную, хоть и схемотехника один-в-один) почти на 30% дешевле.
